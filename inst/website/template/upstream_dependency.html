<% if(n_total > 0) { %>
<% if(n_used > 0) { %>
<p>In total '<%=pkg$package%>' has <%=n_total%> upstream package<%=ifelse(n_total > 1, 's', '')%>. Only <%=n_used%> upstream packages with heaviness on '<%=pkg$package%>' larger than 5 are listed in the following table. Note nine base packages (<code>c("base", "compiler", "datasets", "graphics", "grDevices", "grid", "methods",
        "parallel", "splines", "stats", "stats4", "tcltk", "tools", "utils")</code>) are removed from this table.</p>
<div>In <b>Dependency path</b> colunn, the form of <span style="display:inline-block;vertical-align:top;color:#c7254e;">A</span><span style="display:inline-block;vertical-align:top;padding:0px 4px;color:#c7254e;">â†’<br><span style="font-size:0.8em;color:#c7254e;">k</span></span><span style="display:inline-block;vertical-align:top;color:#c7254e;">B</span> means package A contribute a direct heaviness of <i>k</i> on package B.</div>
<p><b>Heaviness from upstream on '<%=pkg$package%>':</b> number of required packages that can be reduced if moving upstream package to <code>Suggests</code> of its child package in the dependency path.</p>
<% 
  el = upstream_dependency(pkg$package)
  g = igraph::graph.edgelist(as.matrix(unique(el[, 1:2])))
    
for(i in seq_len(nrow(upstream_tb))) {

      sp = igraph::all_shortest_paths(g, upstream_tb[i, 1], pkg$package)$res
      upstream_tb[i, "path"] = paste(sapply(sp, function(x) {
        p = names(x)
        txt = paste0("<div><span style='display:inline-block;vertical-align:top;'><a href='?package=", p[1], "'>", p[1], "</a></span>")
        for(i in seq_len(length(p) - 1)) {
          txt = paste0(txt, "<span style='display:inline-block;vertical-align:top;padding:0px 4px;'>", "&#8594;<br><span style='font-size:0.8em;'>", df[["hv_downstream_values"]][[ p[i] ]][ p[i+1] ], "</span></span><span style='display:inline-block;vertical-align:top;'><a href='?package=", p[i+1], "'>", p[i+1], "</a></span>")
        }
        paste0(txt, "</div>")
      }), collapse = "")
      upstream_tb[i, "path_len"] = max(sapply(sp, length))
    }
upstream_tb$package = qq("<a href='?package=@{upstream_tb$package}'>@{upstream_tb$package}</a>", collapse = FALSE)
    %>

<%= as.character(knitr::kable(upstream_tb, format = "html", row.names = FALSE, escape = FALSE, col.names = c("Upstream package", "Dependency path", "Dependency depth", qq("Heaviness from upstream on '@{pkg$package}'")), table.attr = "class='table table-striped'")) %>

  <% nr = n_used
  if(nr > 25) { %>
    <%= page_select2(page, ceiling(nr/25), "upstream_dependency", pkg$package) %>
  <% } %>

<style>
#cy-upstream-dep {
  border: 1px solid #c5c5c5;
  width: 100%;
  height: 500px;
}
</style>

<p>Dependency paths in the table are represented as the following graph. <span><a class='fake-link' onclick="load_upstream_dep_nt();" style="font-size: 0.8em;">Reset graph</a></span> | <span><a class='fake-link' onclick="load_upstream_dep_nt('LR');" style="font-size: 0.8em;">Horizontal layout</a></span></p>
<div id='cy-upstream-dep'></div>


<script src='js/cytoscape.min.js'></script>
<script src='js/dagre.min.js'></script>
<script src='js/cytoscape-dagre.js'></script>
<script type='text/javascript'>

load_upstream_dep_nt = function(rankDir = "TB") {

<%=network_in_json(nt)%>

  var cy = cytoscape({
    container: document.getElementById('cy-upstream-dep'),
    boxSelectionEnabled: false,
    autounselectify: true,
    elements: nt,
    layout: {
      name: 'dagre',
      nodeSep: 5,
      rankDir: rankDir
    },
    style: [
      {
        selector: 'node',
        style: {
          'content': 'data(id)',
          'text-valign': 'center',
          'text-halign': 'center',
          'background-color': '#11479e'
        }
      },

      {
        selector: 'edge',
        style: {
          'width': 4,
          "label": "data(weight)",
          'target-arrow-shape': 'triangle',
          'line-color': '#9dbaea',
          'target-arrow-color': '#9dbaea',
          'curve-style': 'bezier'
        }
      }
    ]
  });
  
  cy.$('node').one('click', function(e){
    var ele = e.target;
    window.open('package?package=' + ele.id(), '_self')
  });

}
</script>

<% } else { %>
<p>In total there are <%=n_total%> upstream dependencied, but no upstream package has heaviness larger than 5 on '<%=pkg$package%>'.</p>

<% } %>

<% } else { %>

<p>No upstream dependency (not including base packages) found.</p>

<% } %>
